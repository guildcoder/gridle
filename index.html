<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gridle</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="icons/icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{
    --bg:#000;
    --neon-cyan:#00f0ff;
    --neon-red:#ff2b2b;
    --frame-pad:12px;
    --font: 'Orbitron', system-ui, sans-serif;
  }
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

  html,body{height:100%;margin:0;background:var(--bg);color:#cfeaff;font-family:var(--font);}

  .app{
    height:100vh; width:100vw; display:flex;
    flex-direction:column; justify-content:center;
    align-items:center; overflow:hidden; padding:12px;
    user-select:none; -webkit-user-select:none;
  }

  /* Floating neon title */
  .title {
    position:absolute; top:20px; left:50%;
    transform:translateX(-50%);
    font-size:48px; font-weight:700;
    font-style:italic; color:var(--neon-cyan);
    text-shadow: 0 0 6px var(--neon-cyan), 0 0 14px var(--neon-cyan);
    pointer-events:none; z-index:50;
  }

  .frame {
    width:min(96vw,600px);
    height:min(96vw,600px);
    max-height:92vh;
    background:#000;
    border-radius:14px;
    position:relative;
    box-shadow:0 0 30px rgba(0,255,255,0.05);
    display:flex; align-items:center; justify-content:center;
    padding:var(--frame-pad);
    border:4px solid rgba(0,255,255,0.06);
  }

  .frame::after{
    content:''; position:absolute; inset:calc(var(--frame-pad) - 6px);
    border-radius:12px;
    box-shadow: 0 0 28px var(--neon-cyan), inset 0 0 10px rgba(0,255,255,0.04);
    pointer-events:none;
  }

  canvas.game {
    width:100%; height:100%; border-radius:8px;
    background:#000; display:block; image-rendering: pixelated;
  }

  .controls {
    width:100%; max-width:520px; margin-top:10px;
    display:flex; justify-content:center; gap:12px; align-items:center;
  }

  .button {
    background:#000; border:2px solid var(--neon-cyan);
    color:var(--neon-cyan); padding:10px 14px; border-radius:10px;
    font-weight:700; min-width:160px; text-align:center; cursor:pointer;
    box-shadow: 0 6px 18px rgba(0,255,255,0.06);
  }
  .button.hidden{ display:none; }

  .touch-controls { display:flex; align-items:center; gap:12px; background:transparent; }

  .control-rect { width:64px; height:48px; border-radius:8px;
    background:#000; border:3px solid var(--neon-cyan);
    display:flex; align-items:center; justify-content:center; position:relative;
  }
  .control-rect .triangle{ width:0;height:0;border-style:solid;opacity:0.95; }
  .left .triangle { border-width:12px 16px 12px 0;border-color:transparent var(--neon-cyan) transparent transparent; transform:translateX(-6px); }
  .right .triangle { border-width:12px 0 12px 16px;border-color:transparent transparent transparent var(--neon-cyan); transform:translateX(6px); }

  .disc-button { width:56px;height:56px;border-radius:50%;
    border:4px solid var(--neon-cyan); display:flex;align-items:center;justify-content:center;
    background:#000;font-weight:900;font-size:20px;
  }

  .popup {
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.85);
    border:3px solid var(--neon-cyan);
    padding:20px 24px; border-radius:12px;
    text-align:center; z-index:30; display:none; min-width:260px;
  }
  .popup.show{ display:block; animation:pop .24s ease-out; }
  @keyframes pop { from { transform:translate(-50%,-54%) scale(.98); opacity:0 } to { transform:translate(-50%,-50%) scale(1); opacity:1 } }

  .popup h2{ color:var(--neon-cyan); margin:0 0 8px 0; font-size:18px; letter-spacing:1px; }
  .popup p{ margin:0; color:#cfeaff; font-size:14px; }

  .meta {
    margin-top:8px; color:#0ff; font-size:13px; opacity:0.85; text-align:center;
    width:100%; max-width:520px;
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="title">GRIDLE</div>
    <div class="frame" id="game-frame">
      <canvas id="game" class="game"></canvas>
      <div class="popup" id="endPopup" role="dialog" aria-live="polite">
        <h2 id="popupTitle">You did it!</h2>
        <p id="popupBody">Time: 00:00.000</p>
      </div>
    </div>

    <div class="controls" id="controls">
      <button id="playBtn" class="button">Play Today's Challenge</button>
      <div id="inGameControls" class="touch-controls hidden" aria-hidden="true">
        <div id="turnLeft" class="control-rect left" role="button" aria-label="turn left"><div class="triangle"></div></div>
        <div id="discBtn" class="disc-button" role="button" aria-label="throw disc">●</div>
        <div id="turnRight" class="control-rect right" role="button" aria-label="turn right"><div class="triangle"></div></div>
      </div>
      <button id="shareBtn" class="button hidden">Share Today's Challenge</button>
    </div>

    <div class="meta">Gridle — Daily Grid Challenge. Controls: Left/Right or tap arrows. Space / disc button to throw.</div>
  </div>

<script>
// ---------- Utilities ----------
function mulberry32(a){return function(){var t=a+=0x6D2B79F5|0;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return ((t^(t>>>14))>>>0)/4294967296}}
function getCentralDateKey(now=new Date()){try{const df=new Intl.DateTimeFormat('en-US',{timeZone:'America/Chicago',year:'numeric',month:'2-digit',day:'2-digit'});const parts=df.formatToParts(now);return `${parts.find(p=>p.type==='year').value}-${parts.find(p=>p.type==='month').value}-${parts.find(p=>p.type==='day').value}`}catch(e){const ms=now.getTime()+(now.getTimezoneOffset()*60000);const centralMs=ms-(6*60*60000);return new Date(centralMs).toISOString().slice(0,10)}}

// ---------- Daily Setup ----------
function dailySeedFromDateKey(dateKey){
  const [y,m,d]=dateKey.split('-').map(s=>parseInt(s,10));
  const dayOfYear=((()=>{const dt=new Date(y,m-1,d);const start=new Date(y,0,0);return Math.floor((dt-start)/(1000*60*60*24));})());
  const index360=dayOfYear%360; const base=y*1000+index360;
  return (base*2654435761)>>>0;
}

function makeDailySetup(dateKey){
  const seed=dailySeedFromDateKey(dateKey); const rng=mulberry32(seed);
  const sizes=[16,18,20,22,24]; const gridSize=sizes[Math.floor(rng()*sizes.length)];
  const maxBots=Math.max(1, Math.floor(gridSize/4)); const botsCount=Math.floor(rng()*Math.min(6,maxBots))+1;
  const speed=1; const maxTicks=gridSize*gridSize*6;
  const bots=[];
  for(let b=0;b<botsCount;b++){
    const edge=b%4; let x,y,dir; const margin=1;
    if(edge===0){ x=margin; y=1+Math.floor(rng()*(gridSize-2)); dir=0;}
    if(edge===1){ x=gridSize-2; y=1+Math.floor(rng()*(gridSize-2)); dir=2;}
    if(edge===2){ y=margin; x=1+Math.floor(rng()*(gridSize-2)); dir=1;}
    if(edge===3){ y=gridSize-2; x=1+Math.floor(rng()*(gridSize-2)); dir=3;}
    const style=Math.floor(rng()*3); const willFire=rng()<0.5;
    const script=[]; for(let t=0;t<maxTicks;t++){ const p= style===0?(rng()<0.08?(rng()<0.5?-1:1):0):style===1?(rng()<0.12?(rng()<0.5?-1:1):0):(rng()<0.18?(rng()<0.5?-1:1):0); script.push(p);}
    const discTimes=[]; if(willFire){for(let i=0;i<maxTicks;i++){if(rng()<0.03) discTimes.push(i);}}
    bots.push({x,y,dir,script,style,discTimes,tick:0,color:Math.floor(rng()*360)});
  }
  return {N:gridSize,bots,maxTicks};
}

// ---------- Game State ----------
let gameState=null, ctx=null, canvas=null, gameTick=0;
let streak=Number(localStorage.getItem('gridleStreak')||0);

// ---------- Init ----------
function initGame(){
  const dateKey=getCentralDateKey();
  const setup=makeDailySetup(dateKey); const {N,bots,maxTicks}=setup;

  canvas=document.getElementById('game'); canvas.width=N; canvas.height=N;
  ctx=canvas.getContext('2d');

  const grid=Array.from({length:N},()=>Array(N).fill(null));
  const user={x:Math.floor(N/2),y:Math.floor(N/2),dir:0,alive:true};
  grid[user.y][user.x]='user';

  gameState={N,grid,user,bots,maxTicks,tick:0,gameOver:false,dateKey};
  document.getElementById('playBtn').classList.add('hidden');
  document.getElementById('inGameControls').classList.remove('hidden');
  document.getElementById('shareBtn').classList.add('hidden');
  requestAnimationFrame(gameLoop);
}

// ---------- Game Loop ----------
function gameLoop(){
  if(!gameState) return;
  const {N,grid,user,bots,maxTicks}=gameState;
  if(gameState.gameOver) return;

  // --- user movement handled by key/tap ---

  // --- bots AI ---
  bots.forEach(bot=>{
    if(bot.tick>=bot.script.length) return;
    const turn=bot.script[bot.tick]; bot.dir=(bot.dir+turn+4)%4;
    const [nx,ny]=nextPos(bot.x,bot.y,bot.dir);
    if(inBounds(nx,ny,N) && !grid[ny][nx]){ bot.x=nx; bot.y=ny; grid[ny][nx]='bot'+bot.tick; }
    bot.tick++;
  });

  // --- game over check ---
  if(!user.alive || gameState.tick>maxTicks){
    endGame(user.alive);
    return;
  }

  // --- render ---
  drawGrid();
  gameState.tick++;
  requestAnimationFrame(gameLoop);
}

function nextPos(x,y,dir){
  if(dir===0) return [x-1,y]; if(dir===1) return [x,y-1];
  if(dir===2) return [x+1,y]; if(dir===3) return [x,y+1]; return [x,y];
}
function inBounds(x,y,N){ return x>=0&&x<N&&y>=0&&y<N; }

function drawGrid(){
  const {grid,N}=gameState;
  ctx.fillStyle='#000'; ctx.fillRect(0,0,N,N);

  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      if(grid[r][c]===null) continue;
      if(grid[r][c]==='user') ctx.fillStyle='#0ff';
      else ctx.fillStyle='#f22';
      ctx.fillRect(c,r,1,1);
    }
  }

  // brighter grid lines
  ctx.strokeStyle='rgba(0,255,255,0.2)';
  ctx.lineWidth=0.2;
  for(let i=0;i<=N;i++){
    ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,N); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(N,i); ctx.stroke();
  }
}

// ---------- End Game ----------
function endGame(won){
  gameState.gameOver=true;
  const popup=document.getElementById('endPopup');
  popup.querySelector('#popupTitle').textContent=won?'You Won!':'Game Over';
  popup.querySelector('#popupBody').textContent=won?`Congrats!`:'Better luck next time.';
  popup.classList.add('show');

  // streak update
  if(won) streak++; else streak=0;
  localStorage.setItem('gridleStreak',streak);

  document.getElementById('shareBtn').classList.remove('hidden');
  document.getElementById('inGameControls').classList.add('hidden');
}

// ---------- Share as tiny PNG ----------
function buildGridSnapshot(){
  if(!gameState) return null;
  const {N,grid}=gameState;
  const off=document.createElement('canvas');
  off.width=N; off.height=N; const ctxOff=off.getContext('2d');
  ctxOff.fillStyle='#000'; ctxOff.fillRect(0,0,N,N);

  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const val=grid[r][c];
      if(val==='user') ctxOff.fillStyle='#0ff';
      else if(val?.startsWith('bot')) ctxOff.fillStyle='#f22';
      else ctxOff.fillStyle='#000';
      ctxOff.fillRect(c,r,1,1);
    }
  }

  ctxOff.strokeStyle='rgba(0,255,255,0.3)';
  ctxOff.lineWidth=0.2;
  for(let i=0;i<=N;i++){
    ctxOff.beginPath(); ctxOff.moveTo(i,0); ctxOff.lineTo(i,N); ctxOff.stroke();
    ctxOff.beginPath(); ctxOff.moveTo(0,i); ctxOff.lineTo(N,i); ctxOff.stroke();
  }

  return off.toDataURL('image/png');
}

document.getElementById('playBtn').addEventListener('click',initGame);
document.getElementById('shareBtn').addEventListener('click',()=>{
  const snapshot=buildGridSnapshot();
  if(!snapshot) return;
  const win=window.open();
  win.document.write(`<h3>Today's Gridle Challenge</h3><img src="${snapshot}" style="image-rendering:pixelated;width:200px;height:auto;">`);
});
</script>
</body>
</html>
